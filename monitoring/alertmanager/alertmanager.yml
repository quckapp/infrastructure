# QuckApp Alertmanager Configuration
# =============================================================================
# Production Setup:
#   Replace all CHANGE_ME_* placeholders with real credentials.
#   For Kubernetes, override via Helm values.yaml alertmanager.config section.
#   For Docker, this file is mounted directly â€” edit before deploying.
# =============================================================================

global:
  resolve_timeout: 5m

  # SMTP configuration for email alerts
  # Replace CHANGE_ME_* values for production
  smtp_smarthost: 'CHANGE_ME_SMTP_HOST:587'
  smtp_from: 'alertmanager@quckapp.com'
  smtp_auth_username: 'CHANGE_ME_SMTP_USERNAME'
  smtp_auth_password: 'CHANGE_ME_SMTP_PASSWORD'
  smtp_require_tls: true

  # Slack global webhook URL
  # Replace with your Slack incoming webhook URL
  slack_api_url: 'CHANGE_ME_SLACK_WEBHOOK_URL'

# Route configuration
route:
  group_by: ['alertname', 'service', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default-receiver'

  routes:
    # Critical alerts - immediate notification via Slack + PagerDuty + Email
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # Warning alerts - Slack + Email
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 1m
      repeat_interval: 4h

    # Database alerts - dedicated channel
    - match_re:
        alertname: ^(Redis|MySQL|PostgreSQL|MongoDB|Elasticsearch|Kafka).*
      receiver: 'database-receiver'
      group_by: ['alertname', 'database']

# Receivers configuration
receivers:
  # Default receiver - Slack notifications
  - name: 'default-receiver'
    slack_configs:
      - channel: '#quckapp-alerts'
        send_resolved: true
        title: '{{ template "quckapp.slack.title" . }}'
        text: '{{ template "quckapp.slack.text" . }}'
        color: '{{ template "quckapp.slack.color" . }}'
    webhook_configs:
      - url: 'http://localhost:5001/alerts'
        send_resolved: true

  # Critical receiver - Slack + Email + PagerDuty
  - name: 'critical-receiver'
    slack_configs:
      - channel: '#quckapp-alerts-critical'
        send_resolved: true
        title: '{{ template "quckapp.slack.title" . }}'
        text: '{{ template "quckapp.slack.text" . }}'
        color: '{{ template "quckapp.slack.color" . }}'
    email_configs:
      - to: 'oncall@quckapp.com'
        send_resolved: true
        headers:
          Subject: '{{ template "quckapp.email.subject" . }}'
        html: '{{ template "quckapp.email.html" . }}'
    pagerduty_configs:
      # Replace with your PagerDuty service integration key
      - service_key: 'CHANGE_ME_PAGERDUTY_SERVICE_KEY'
        severity: 'critical'
        description: '{{ template "quckapp.description" . }}'
    webhook_configs:
      - url: 'http://localhost:5001/alerts/critical'
        send_resolved: true

  # Warning receiver - Slack + Email
  - name: 'warning-receiver'
    slack_configs:
      - channel: '#quckapp-alerts'
        send_resolved: true
        title: '{{ template "quckapp.slack.title" . }}'
        text: '{{ template "quckapp.slack.text" . }}'
        color: '{{ template "quckapp.slack.color" . }}'
    email_configs:
      - to: 'engineering@quckapp.com'
        send_resolved: true
        headers:
          Subject: '{{ template "quckapp.email.subject" . }}'
        html: '{{ template "quckapp.email.html" . }}'
    webhook_configs:
      - url: 'http://localhost:5001/alerts/warning'
        send_resolved: true

  # Database receiver - dedicated Slack channel
  - name: 'database-receiver'
    slack_configs:
      - channel: '#quckapp-alerts-database'
        send_resolved: true
        title: '{{ template "quckapp.slack.title" . }}'
        text: '{{ template "quckapp.slack.text" . }}'
        color: '{{ template "quckapp.slack.color" . }}'
    email_configs:
      - to: 'dba@quckapp.com'
        send_resolved: true
        headers:
          Subject: '{{ template "quckapp.email.subject" . }}'
        html: '{{ template "quckapp.email.html" . }}'
    webhook_configs:
      - url: 'http://localhost:5001/alerts/database'
        send_resolved: true

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # If critical alert is firing, suppress warning for same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

  # If service is down, suppress other alerts for that service
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '.+'
    equal: ['service']

  # If Kafka is down, suppress consumer lag alerts
  - source_match:
      alertname: 'KafkaDown'
    target_match:
      alertname: 'KafkaConsumerLag'

  # If Elasticsearch is down, suppress cluster health alerts
  - source_match:
      alertname: 'ElasticsearchDown'
    target_match_re:
      alertname: 'ElasticsearchCluster.*'

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'
