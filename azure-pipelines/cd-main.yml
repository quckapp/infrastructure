# =============================================================================
# QuckApp CD Pipeline - Environment Promotion
# =============================================================================
# Deploys services through: dev → QA → uat1 → uat2 → uat3 → staging → prod → live
# Triggered by GitHub Actions (via webhook) or manually
# =============================================================================

trigger: none

pr: none

pool:
  vmImage: 'ubuntu-latest'

resources:
  repositories:
    - repository: github-repo
      type: github
      endpoint: 'GitHubServiceConn'
      name: 'quckapp/quckapp'
      ref: 'refs/heads/main'

parameters:
  - name: serviceName
    displayName: 'Service to deploy (empty = all)'
    type: string
    default: ''
  - name: imageTag
    displayName: 'Image tag to deploy'
    type: string
    default: 'latest'
  - name: startEnvironment
    displayName: 'Start from environment'
    type: string
    default: 'dev'
    values:
      - dev
      - qa
      - uat1
      - uat2
      - uat3
      - staging
      - prod
      - live
  - name: stopAfter
    displayName: 'Stop after environment (empty = deploy through all)'
    type: string
    default: ''
    values:
      - ''
      - dev
      - qa
      - uat1
      - uat2
      - uat3
      - staging
      - prod
      - live

variables:
  - group: QuckApp-Global
  - name: helmChart
    value: 'infrastructure/helm/quikapp'

# =============================================================================
# Stage: Deploy to Dev
# =============================================================================
stages:
  - stage: Deploy_Dev
    displayName: 'Deploy to Dev'
    condition: |
      and(
        succeeded(),
        in('${{ parameters.startEnvironment }}', 'dev')
      )
    jobs:
      - deployment: deploy_dev
        displayName: 'Deploy to Dev'
        environment: 'quckapp-dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'dev'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'

  # ===========================================================================
  # Stage: Deploy to QA
  # ===========================================================================
  - stage: Deploy_QA
    displayName: 'Deploy to QA'
    dependsOn: Deploy_Dev
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'qa')),
        ne('${{ parameters.stopAfter }}', 'dev')
      )
    jobs:
      - deployment: deploy_qa
        displayName: 'Deploy to QA'
        environment: 'quckapp-qa'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'qa'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'
                - template: templates/integration-tests.yml
                  parameters:
                    environment: 'qa'
                    namespace: 'quckapp-qa'

  # ===========================================================================
  # Stage: Deploy to UAT1
  # ===========================================================================
  - stage: Deploy_UAT1
    displayName: 'Deploy to UAT1'
    dependsOn: Deploy_QA
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'uat1')),
        ne('${{ parameters.stopAfter }}', 'qa')
      )
    jobs:
      - deployment: deploy_uat1
        displayName: 'Deploy to UAT1'
        environment: 'quckapp-uat1'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'uat1'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'

  # ===========================================================================
  # Stage: Deploy to UAT2
  # ===========================================================================
  - stage: Deploy_UAT2
    displayName: 'Deploy to UAT2'
    dependsOn: Deploy_QA
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'uat2')),
        ne('${{ parameters.stopAfter }}', 'qa')
      )
    jobs:
      - deployment: deploy_uat2
        displayName: 'Deploy to UAT2'
        environment: 'quckapp-uat2'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'uat2'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'

  # ===========================================================================
  # Stage: Deploy to UAT3
  # ===========================================================================
  - stage: Deploy_UAT3
    displayName: 'Deploy to UAT3'
    dependsOn: Deploy_QA
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'uat3')),
        ne('${{ parameters.stopAfter }}', 'qa')
      )
    jobs:
      - deployment: deploy_uat3
        displayName: 'Deploy to UAT3'
        environment: 'quckapp-uat3'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'uat3'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'

  # ===========================================================================
  # Stage: Deploy to Staging
  # ===========================================================================
  - stage: Deploy_Staging
    displayName: 'Deploy to Staging'
    dependsOn:
      - Deploy_UAT1
      - Deploy_UAT2
      - Deploy_UAT3
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'staging')),
        not(in('${{ parameters.stopAfter }}', 'uat1', 'uat2', 'uat3'))
      )
    jobs:
      - deployment: deploy_staging
        displayName: 'Deploy to Staging'
        environment: 'quckapp-staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'staging'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'
                    helmTimeout: '20m'
                - template: templates/integration-tests.yml
                  parameters:
                    environment: 'staging'
                    namespace: 'quckapp-staging'

  # ===========================================================================
  # Stage: Deploy to Prod
  # ===========================================================================
  - stage: Deploy_Prod
    displayName: 'Deploy to Production'
    dependsOn: Deploy_Staging
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'prod')),
        ne('${{ parameters.stopAfter }}', 'staging')
      )
    jobs:
      - deployment: deploy_prod
        displayName: 'Deploy to Production'
        environment: 'quckapp-production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'prod'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'
                    helmTimeout: '20m'

  # ===========================================================================
  # Stage: Deploy to Live
  # ===========================================================================
  - stage: Deploy_Live
    displayName: 'Deploy to Live'
    dependsOn: Deploy_Prod
    condition: |
      and(
        or(succeeded(), in('${{ parameters.startEnvironment }}', 'live')),
        ne('${{ parameters.stopAfter }}', 'prod')
      )
    jobs:
      - deployment: deploy_live
        displayName: 'Deploy to Live'
        environment: 'quckapp-live'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: github-repo
                  submodules: true
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'live'
                    serviceName: '${{ parameters.serviceName }}'
                    imageTag: '${{ parameters.imageTag }}'
                    helmTimeout: '20m'
                - template: templates/integration-tests.yml
                  parameters:
                    environment: 'live'
                    namespace: 'quckapp-live'
