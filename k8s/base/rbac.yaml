# =============================================================================
# SERVICE ACCOUNTS
# =============================================================================

# Default service account for all services
apiVersion: v1
kind: ServiceAccount
metadata:
  name: quckapp-service-account
  namespace: quckapp
  labels:
    app.kubernetes.io/name: quckapp
  annotations:
    azure.workload.identity/client-id: ""  # Set from Terraform
---
# Service account for backend services (database access)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: quckapp-backend-sa
  namespace: quckapp
  labels:
    app.kubernetes.io/name: quckapp
    app.kubernetes.io/component: backend
---
# Service account for worker services (queue processing)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: quckapp-worker-sa
  namespace: quckapp
  labels:
    app.kubernetes.io/name: quckapp
    app.kubernetes.io/component: worker
---
# =============================================================================
# ROLES
# =============================================================================

# Role for reading ConfigMaps and Secrets
apiVersion: rbac.authorization.k8s.io/api/v1
kind: Role
metadata:
  name: quckapp-config-reader
  namespace: quckapp
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch"]
---
# Role for service discovery
apiVersion: rbac.authorization.k8s.io/api/v1
kind: Role
metadata:
  name: quckapp-service-discovery
  namespace: quckapp
rules:
  - apiGroups: [""]
    resources: ["services", "endpoints", "pods"]
    verbs: ["get", "list", "watch"]
---
# =============================================================================
# ROLE BINDINGS
# =============================================================================

# Bind config reader to default service account
apiVersion: rbac.authorization.k8s.io/api/v1
kind: RoleBinding
metadata:
  name: quckapp-config-reader-binding
  namespace: quckapp
subjects:
  - kind: ServiceAccount
    name: quckapp-service-account
    namespace: quckapp
  - kind: ServiceAccount
    name: quckapp-backend-sa
    namespace: quckapp
  - kind: ServiceAccount
    name: quckapp-worker-sa
    namespace: quckapp
roleRef:
  kind: Role
  name: quckapp-config-reader
  apiGroup: rbac.authorization.k8s.io
---
# Bind service discovery to all service accounts
apiVersion: rbac.authorization.k8s.io/api/v1
kind: RoleBinding
metadata:
  name: quckapp-service-discovery-binding
  namespace: quckapp
subjects:
  - kind: ServiceAccount
    name: quckapp-service-account
    namespace: quckapp
  - kind: ServiceAccount
    name: quckapp-backend-sa
    namespace: quckapp
roleRef:
  kind: Role
  name: quckapp-service-discovery
  apiGroup: rbac.authorization.k8s.io
---
# =============================================================================
# POD SECURITY POLICIES (via Pod Security Standards)
# =============================================================================
apiVersion: v1
kind: Namespace
metadata:
  name: quckapp
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
